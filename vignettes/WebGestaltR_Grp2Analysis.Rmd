---
title: "FGCZ Over-Representation Analysis (ORA)"
subtitle: "Using the `WebGestaltR` package"
author: "Functional Genomics Center Zurich"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: 
    number_sections: false
params:
  grp: !r quote(SRMService::mqQuantMatrixGRP2)
vignette: >
  %\VignetteIndexEntry{FGCZ WebGestaltR}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
bibliography: bibliography.bib
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)

if(!exists("progress")){
  progress <- function(howmuch, detail){
    invisible(NULL)
  }
}

grp2 <- eval(params$grp)

library(tidyverse)
library(knitr)
library(reshape2)
library(quantable)
library(ggplot2)
library(rlang)
library(WebGestaltR)
```

# Introduction

The following analysis compares protein clusters identified via unsupervised hierarchical clustering in two groups of samples (Tables \@ref(tab:samples) and \@ref(tab:annotation)) by applying an over-representation analysis (*ORA*) on the proteins compared to the background of all measured proteins in the dataset. In principle, *ORA* compares the number of observed proteins of a specific pathway in the cluster of interest to the number one would expect to show up by chance (hence a reference list). These statistics are then translated into a *P*-value and adjusted for multiplicity, since potentially many pathways are tested [@Leong2009]. This then yields the reported *Q*-value in table \@ref(tab:results). *ORA* is implemented in the `R` package `WebGestaltR` [@Wang2017].


The protein identification and quantification were performed using the _MaxQuant_ software and _Andromeda_ search engine [@Cox2008, @Cox2011]. Based on the  `proteinGroups.txt`  file we generated by MaxQuant; we run a set of functions implemented in the `R` package `SRMService` [@SRMService2018] to generate visualizations.


## Experiment summary


This report was is stored in the LIMS system _bfabric_ <https://fgcz-bfabric.uzh.ch> [@Trker2010] in the project `r grp2$projectID`, with the workunit name : `r grp2$projectName`.

This report was created from data stored in _bfabric_ and can be downloaded using:

- workunit Id : `r grp2$workunitID`
- project Id: `r grp2$projectID`.


The protein matrix is filtered with the following thresholds:

- Minimum number of peptides / protein: `r grp2$nrPeptides`
- Maximum of missing values per protein : `r grp2$maxNA`


- The total number of proteins in this experiment is: `r nrow(grp2$proteinIntensity)` 
- Total number without decoys sequences is `r nrow(grp2$proteinIntensity) -  sum(grepl("REV__",grp2$proteinAnnotation$ProteinName))` 


- Percentage of contaminants : `r round(mean(grepl("CON__",grp2$proteinAnnotation$ProteinName)) * 100, digits=1)` %
- Percentage of false positives : `r round(mean(grepl("REV__",grp2$proteinAnnotation$ProteinName)) * 100, digits=1)` %

ORA was performed with the following parameters:

- Organism: `r organism`
- Database: `r enrichDatabase`
- Number of protein clusters submitted to ORA: `r grp2$getNumberOfClusters()`

```{r samples}
tab <- data.frame(table(grp2$getAnnotation()$Condition))
colnames(tab) <- c("Condition","# samples")
knitr::kable(tab, caption="Nr of samples in each condition.", align = "c")
```

Table \@ref(tab:samples) shows the number of samples in each condition while Table \@ref(tab:annotation) shows the raw files assigned to the conditions.

```{r annotation}
tab <- grp2$getAnnotation()[,c("Condition","Raw.file")]
rownames(tab) <- NULL
knitr::kable(tab, caption="Condition sample mapping.", align = "c")
```

\pagebreak

# OR Analysis

## Protein clustering

```{r heatmapData, fig.width=8, fig.height=5, dpi=300, fig.cap="Heatmap of normalized data.", fig.align='center'}
tmp <- grp2$getNormalized()$data
stmMm <- grp2$getNormalized()$data[grp2$getNrNAs() < ncol(grp2$getNormalized()$data)/2,]
col = c("blue", "red")
tmp2 <- simpleheatmap3((scale(t(stmMm),scale = F)),
                       RowSideColors = col[as.factor(grp2$getAnnotation()$Condition)],
                       margins=c(1,10),
                       breaks=seq(-2.5,2.5,length=26),
                       palette = getBlueWhiteRed(25),
                       labCol="",
                       nrOfClustersCol = grp2$getNumberOfClusters(),
                       labRow=colnames(stmMm),
                       showColDendro = FALSE )
progress(0.2, "Heatmaps")
```

## ORA output {.tabset .tabset-pills}

Note that the geneset column directly refers the reader to the corresponding pathway webpage. If no data is available on a cluster no significantly enriched pathway could be reported.

```{r results, results='asis'}
X <- aggregated_results %>%
  mutate(geneset = pander::pandoc.link.return(link, text = geneset)) %>%
  select(geneset, PValue, FDR, file.origin)

for (i in unique(X$file.origin)) {
  cat("### Protein cluster ", i, "\n")
  
  X %>% 
    filter(file.origin == i) %>%
    knitr::kable(
      x = .,
      align = "c",
      caption = paste0("Results for cluster ", i, "."),
      digits = 4,
      escape = TRUE,
      col.names = c("Gene Set", "*P* Value", "*Q* Value", "Protein Cluster")
    ) %>% print
  
  cat("\n")
}

  
```

\pagebreak

# References
