---
title: "SRM"
author: "FGCZ"
date: "23 October 2017"
output: html_document
---


```{r include=FALSE}
library(quantable)
library(knitr)
opts_chunk$set(echo=FALSE, message=FALSE, results = 'hide', warnings=FALSE)

```



# Distribution of qValues

```{r}
srms$qValueHist()
```

Histogram of qValues for all SRM assays. The red line indicates the qValue threshold - we control the False Discovery Rate (fdr) at this level. 



# Remove all transitions with more than X missing values

Histogram showing the number of missing values for the heavy peptides in all samples.
The red line indicates the maximum of NA's allowed.


```{r fig.cap="Distribution of NA's for heavy peptides"}
srms$getNrNAs()
```

Histogram showing the number of missing values for the light peptides in all samples.
The red line indicates the maximum of NA's allowed.



```{r fig.cap="Distribution of NA's for light peptides."}
srms$getNrNAs(light=TRUE)

```


# Heatmap of log2(L/H)

```{r fig.cap="Missing values log2(L/H) per Transtion."}
foldchanges <- srms$getLHLog2FoldChange()
```

```{r fig.height=20, fig.width=10, fig.cap="heatmap of log2 fold changes transtion level"}
foldchanges$plot()
```

## Transitions dropped because of to many NA's in log2 fold change.

```{r results='markup'}
all <-srms$getTransitionIntensities(100)
knitr::kable(quantable::setdiff.data.frame(all$ids[,1:(ncol(all$ids)-1)], foldchanges$ids), row.names=FALSE, caption="removed transitions (to many NA's)")

``` 


# Peptide Quantification

The following plots show Log2(H/L) of peptides belonging to the same proteins (y axis) given samples (x axis).
These fold changes will be used to compute the fold H/L fold change of the protein in a sample.

## Remove all peptides with only one transition.


```{r}
foldchanges <- srms$getLHLog2FoldChange(plot=F)
foldchanges$dim()
filteredfc <- (foldchanges$filterData(minNrTransition = 2))
filteredfc$dim()

```

```{r results='markup'}
knitr::kable(quantable::setdiff.data.frame(foldchanges$ids, filteredfc$ids),row.names = FALSE,
             caption = "peptides removed since only a single valid transition")
```


\newpage

# Removing decorrelated transitions

```{r}

curatedTransitions <- filteredfc$removeDecorrelated(TransitionCorrelationThreshold)
```

\newpage

# List of peptides removed

Peptides might have been removed since there were no quantified transtions, only a single transition was quantified or  the transition were uncorrelated.

```{r results="markdown"}
knitr::kable(setdiff.data.frame(all$getPeptideIDs() ,  curatedTransitions$getPeptideIDs() ), row.names = FALSE, caption= "All removed peptides. ")

```

\newpage

# List of peptides available after transition processing

```{r results='markup'}
knitr::kable(table(curatedTransitions$getPeptideIDs()[,2:3]),row.names = TRUE,
             caption = "Peptides Still available and Nr of transitions per peptide. Columns charge state.")
```

# Peptide Intensities

```{r plotPeptides, fig.width=9, fig.height=8, fig.cap="Traces of all peptides"}
peptides <- curatedTransitions$getPeptideIntensities()
peptides$plot()
```

Correlation filtering of peptide intensities

```{r, fig.width=9, fig.height=8, fig.cap="Traces of correlated peptides"}
correlatedPeptides <- peptides$removeDecorrelated(PeptideCorrelationThreshold)


correlatedPeptides$plot()

```

```{r fig.cap="Change in peptide numbers due to filtering. X-axis unfiltered, Y-axis filtered data."}
countrows <- function(x){if(is.null(x)){return(0)}else{nrow(x)}}
nrPepUnfiltered<-sapply(peptides$getProteinsAsList(),nrow)
nrPepFiltered <-sapply(correlatedPeptides$getProteinsAsList(),countrows)
plot(jitter(nrPepUnfiltered),jitter(nrPepFiltered))

```


```{r results="markdown"}
length(all$getPeptideIDs())

                   
knitr::kable(setdiff.data.frame(all$getPeptideIDs() ,
                                correlatedPeptides$getPeptideIDs() ),
             row.names = FALSE,
             caption= "All removed peptides because of decorrelation on peptide level. ")
```

# Peptides available for quantification after peptide correlation filtering

```{r results='markup'}
knitr::kable(table(correlatedPeptides$getPeptideIDs()[,2:3]),row.names = TRUE,
             caption = "Peptides Still available for Quantification. Columns charge state.")
```

# Protein Intensities

```{r writeprotein, fig.width=9, fig.height=8}
correlatedPeptides$getProteinIntensities(scale=FALSE)
```


\newpage

# List of quantified proteins

```{r listQuantified, results="markup"}
proteinslist <- correlatedPeptides$getProteinsAsList()
proteins <- data.frame( Portein = names(proteinslist), NrPeptides=  sapply(proteinslist, countrows))
proteins <- subset(proteins, NrPeptides > 0)

knitr::kable(proteins,caption="Quantified proteins with number of peptides used for quantification", row.names = FALSE)

```

\newpage

# List of proteins not quantified

```{r results="markup"}
remprot <- t(t(setdiff(unique(all$ids$Protein.Name),rownames(proteins))))
colnames(remprot) <- "proteins"
knitr::kable(remprot,caption="removed proteins")

```


\newpage

# Proteins and their Peptides

```{r fig.width=8, fig.height=7,dpi=300}

xl <-peptides$getProteinsAsList()
length(xl)
x2 <-correlatedPeptides$getProteinsAsList()
x2<-x2[!sapply(x2,is.null)]

for(i in 1:length(xl)){
  plotNicely(xl[[i]],main=names(xl)[i])
}
```

\newpage


# Peptides and their transitions


```{r fig.width=8, fig.height=7}
peplist <- curatedTransitions$getPeptidesAsList()

for(i in 1:length(peplist)){
  SRMService::plotNicely(peplist[[i]],main = names(peplist)[i] )  
}


```



